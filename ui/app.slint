import {
    Button,
    VerticalBox,
    ComboBox,
    LineEdit,
    ProgressIndicator,
    HorizontalBox,
    GroupBox,
} from "std-widgets.slint";

import { SettingsPage } from "pages/settings_page.slint";
import { ServerConfigUI, BookmarkEntry } from "types.slint";
import { FileEntry } from "components/file_item.slint";
import { LocalPanel } from "panels/local_panel.slint";
import { RemotePanel } from "panels/remote_panel.slint";
import { TransferEntry } from "components/transfer_item.slint";
import { TransferPanel } from "panels/transfer_panel.slint";
import { QuickUploadPanel } from "panels/quick_upload_panel.slint";
import { ConfirmDialog } from "components/confirm_dialog.slint";
import { Style } from "theme/style.slint";
export { ServerConfigUI, FileEntry, TransferEntry, BookmarkEntry }

export component AppWindow inherits Window {
    title: "Flick 文件传输";
    min-width: 700px;
    min-height: 500px;
    default-font-family: "Microsoft YaHei";
    in-out property <bool> show-settings: false;
    in-out property <int> current-settings-index: -1;
    in-out property <ServerConfigUI> current-config: {
        name: "New Server",
        host: "127.0.0.1",
        port: "22",
        user: "root",
        auth_type: "password",
        password: "",
        key_path: "",
        default_target_dir: "/tmp"
    };
    callback save-config(int, ServerConfigUI);
    callback delete-config(int);
    callback pick-key-file();
    callback load-config(int);
    callback test-connection(ServerConfigUI);
    in-out property <string> test-result: "";
    in-out property <bool> test-success: false;
    in-out property <bool> is-testing: false;
    in-out property <string> test-log: "";
    in-out property <bool> show-log: false;
    in property <string> ssh-key-hint: "留空自动探测 (Agent/Default)";
    in property <[string]> servers: ["本地测试服务器"];

    // 本地文件浏览器
    in property <string> local-path: "";
    in property <[FileEntry]> local-files: [];
    callback local-navigate(string);
    callback local-go-up();
    callback local-file-clicked(int);
    callback local-file-clicked-ex(int, bool, bool);
    callback local-file-double-clicked(int);
    callback local-refresh();
    callback local-select-all();
    callback local-mkdir(string);
    callback local-delete-selected();
    callback local-rename(int, string);
    callback local-sort-changed(string);
    in-out property <string> local-sort-field: "name";
    in-out property <bool> local-sort-ascending: true;
    callback local-filter-changed(string);
    in-out property <bool> local-show-search: false;

    // 远程文件浏览器
    in property <string> remote-path: "/";
    in property <[FileEntry]> remote-files: [];
    in property <bool> remote-connected: false;
    in property <bool> remote-connecting: false;
    in property <string> remote-status: "";
    in-out property <int> remote-server-index: 0;
    callback remote-connect(int);
    callback remote-disconnect();
    callback remote-navigate(string);
    callback remote-go-up();
    callback remote-file-clicked(int);
    callback remote-file-clicked-ex(int, bool, bool);
    callback remote-file-double-clicked(int);
    callback remote-refresh();
    callback remote-select-all();
    callback remote-mkdir(string);
    callback remote-delete-selected();
    callback remote-rename(int, string);
    callback remote-sort-changed(string);
    in-out property <string> remote-sort-field: "name";
    in-out property <bool> remote-sort-ascending: true;
    callback remote-filter-changed(string);
    in-out property <bool> remote-show-search: false;

    // 传输队列
    in property <[TransferEntry]> transfer-tasks: [];
    in property <bool> has-transfer-tasks: false;
    callback clear-completed-transfers();
    callback retry-transfer(int);
    callback upload-selected();
    callback download-selected();

    // 快速上传模式
    in-out property <bool> quick-upload-mode: false;
    in-out property <string> file-path: "未选择文件";
    in-out property <string> target-dir: "/tmp";
    in-out property <bool> is-uploading: false;
    in-out property <float> progress: 0.0;
    in-out property <string> status-log: "";
    callback pick-file();
    callback server-selected(int);
    callback start-upload(int);

    // 全局错误提示
    in-out property <string> global-error: "";

    // 书签
    in property <[BookmarkEntry]> bookmarks: [];
    in-out property <bool> show-bookmarks: false;
    callback add-bookmark(string, string, string);  // name, path, side
    callback remove-bookmark(int);
    callback goto-bookmark(int);

    // 状态栏
    in property <int> local-file-count: 0;
    in property <int> local-selected-count: 0;
    in property <int> remote-file-count: 0;
    in property <int> remote-selected-count: 0;

    // 焦点面板: "local" 或 "remote"
    in-out property <bool> focus-on-remote: false;

    // 面板分割比例 (0.0 ~ 1.0，左面板占比)
    in-out property <float> split-ratio: 0.5;

    // 确认对话框
    in-out property <bool> show-confirm: false;
    in-out property <string> confirm-title: "确认";
    in-out property <string> confirm-message: "";
    in-out property <string> confirm-action: "";
    callback confirm-accepted();

    // 快速上传面板
    QuickUploadPanel {
        visible: root.quick-upload-mode && !root.show-settings;
        file-path: root.file-path;
        servers: root.servers;
        target-dir: root.target-dir;
        is-uploading: root.is-uploading;
        progress: root.progress;
        status-log: root.status-log;
        pick-file() => {
            root.pick-file();
        }
        server-selected(idx) => {
            root.server-selected(idx);
        }
        start-upload(idx) => {
            root.start-upload(idx);
        }
    }

    // 主界面（双面板）+ 键盘快捷键
    FocusScope {
        visible: !root.show-settings && !root.quick-upload-mode;
        key-pressed(event) => {
            if (event.text == Key.Tab) {
                root.focus-on-remote = !root.focus-on-remote;
                return accept;
            }
            if (event.text == Key.F5) {
                if (root.focus-on-remote) { root.remote-refresh(); }
                else { root.local-refresh(); }
                return accept;
            }
            if (event.text == Key.Delete) {
                if (root.focus-on-remote) { root.remote-delete-selected(); }
                else { root.local-delete-selected(); }
                return accept;
            }
            if (event.text == Key.Backspace) {
                if (root.focus-on-remote) { root.remote-go-up(); }
                else { root.local-go-up(); }
                return accept;
            }
            if (event.modifiers.control && event.text == "a") {
                if (root.focus-on-remote) { root.remote-select-all(); }
                else { root.local-select-all(); }
                return accept;
            }
            if (event.modifiers.control && event.text == "f") {
                if (root.focus-on-remote) { root.remote-show-search = !root.remote-show-search; }
                else { root.local-show-search = !root.local-show-search; }
                return accept;
            }
            return reject;
        }
    VerticalBox {
        padding: 20px;
        spacing: 15px;
        HorizontalBox {
            alignment: space-between;
            Text {
                text: "Flick";
                font-size: 24px;
                font-weight: 700;
            }

            Button {
                text: "设置";
                width: 60px;
                clicked => {
                    root.show-settings = true;
                    root.current-settings-index = -1;
                    root.current-config = {
                        name: "New Server",
                        host: "",
                        port: "22",
                        user: "root",
                        auth_type: "password",
                        password: "",
                        key_path: "",
                        default_target_dir: "/tmp"
                    };
                }
            }
        }

        // 双面板文件浏览器
        panels-area := Rectangle {
            vertical-stretch: 1;
            LocalPanel {
                x: 0px;
                y: 0px;
                width: panels-area.width * root.split-ratio - 3px;
                height: panels-area.height;
                current-path: root.local-path;
                files: root.local-files;
                navigate(p) => {
                    root.local-navigate(p);
                }
                go-up() => {
                    root.local-go-up();
                }
                file-clicked(i) => {
                    root.local-file-clicked(i);
                }
                file-clicked-ex(i, ctrl, shift) => {
                    root.local-file-clicked-ex(i, ctrl, shift);
                }
                file-double-clicked(i) => {
                    root.local-file-double-clicked(i);
                }
                refresh() => {
                    root.local-refresh();
                }
                select-all() => {
                    root.local-select-all();
                }
                mkdir(name) => {
                    root.local-mkdir(name);
                }
                delete-selected() => {
                    root.local-delete-selected();
                }
                rename-item(i, name) => {
                    root.local-rename(i, name);
                }
                sort-field: root.local-sort-field;
                sort-ascending: root.local-sort-ascending;
                sort-changed(field) => {
                    root.local-sort-changed(field);
                }
                show-search: root.local-show-search;
                filter-changed(text) => {
                    root.local-filter-changed(text);
                }
                bookmarks: root.bookmarks;
                add-bookmark() => {
                    root.add-bookmark(root.local-path, root.local-path, "local");
                }
                goto-bookmark(i) => {
                    root.goto-bookmark(i);
                }
                remove-bookmark(i) => {
                    root.remove-bookmark(i);
                }
            }

            // 分隔条
            Rectangle {
                x: panels-area.width * root.split-ratio - 3px;
                y: 0px;
                width: 6px;
                height: panels-area.height;
                background: splitter-touch.has-hover || splitter-touch.pressed ? Style.splitter-active : Style.splitter-default;
                splitter-touch := TouchArea {
                    mouse-cursor: col-resize;
                    moved => {
                        root.split-ratio = Math.max(0.2, Math.min(0.8,
                            (self.mouse-x + panels-area.width * root.split-ratio - 3px) / panels-area.width
                        ));
                    }
                }
            }

            RemotePanel {
                x: panels-area.width * root.split-ratio + 3px;
                y: 0px;
                width: panels-area.width * (1.0 - root.split-ratio) - 3px;
                height: panels-area.height;
                current-path: root.remote-path;
                files: root.remote-files;
                servers: root.servers;
                connected: root.remote-connected;
                connecting: root.remote-connecting;
                status-text: root.remote-status;
                current-server-index <=> root.remote-server-index;
                connect(idx) => {
                    root.remote-connect(idx);
                }
                disconnect() => {
                    root.remote-disconnect();
                }
                navigate(p) => {
                    root.remote-navigate(p);
                }
                go-up() => {
                    root.remote-go-up();
                }
                file-clicked(i) => {
                    root.remote-file-clicked(i);
                }
                file-clicked-ex(i, ctrl, shift) => {
                    root.remote-file-clicked-ex(i, ctrl, shift);
                }
                file-double-clicked(i) => {
                    root.remote-file-double-clicked(i);
                }
                refresh() => {
                    root.remote-refresh();
                }
                select-all() => {
                    root.remote-select-all();
                }
                mkdir(name) => {
                    root.remote-mkdir(name);
                }
                delete-selected() => {
                    root.remote-delete-selected();
                }
                rename-item(i, name) => {
                    root.remote-rename(i, name);
                }
                sort-field: root.remote-sort-field;
                sort-ascending: root.remote-sort-ascending;
                sort-changed(field) => {
                    root.remote-sort-changed(field);
                }
                show-search: root.remote-show-search;
                filter-changed(text) => {
                    root.remote-filter-changed(text);
                }
                bookmarks: root.bookmarks;
                add-bookmark() => {
                    root.add-bookmark(root.remote-path, root.remote-path, "remote");
                }
                goto-bookmark(i) => {
                    root.goto-bookmark(i);
                }
                remove-bookmark(i) => {
                    root.remove-bookmark(i);
                }
            }
        }

        // 传输操作按钮
        HorizontalBox {
            alignment: center;
            spacing: 20px;
            padding-top: 10px;
            padding-bottom: 10px;
            Button {
                text: "上传选中文件";
                enabled: root.remote-connected;
                width: 150px;
                clicked => {
                    root.upload-selected();
                }
            }

            Button {
                text: "下载选中文件";
                enabled: root.remote-connected;
                width: 150px;
                clicked => {
                    root.download-selected();
                }
            }
        }

        // 传输队列面板
        TransferPanel {
            tasks: root.transfer-tasks;
            has-tasks: root.has-transfer-tasks;
            clear-completed => {
                root.clear-completed-transfers();
            }
            retry-transfer(id) => {
                root.retry-transfer(id);
            }
        }

        // 状态栏
        Rectangle {
            height: 28px;
            background: Style.bg-status;
            border-radius: 4px;
            border-width: 1px;
            border-color: Style.border-color;
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                spacing: 8px;
                Text {
                    text: "本地: " + root.local-file-count + " 项";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: Style.text-secondary;
                }
                if root.local-selected-count > 0: Text {
                    text: "(" + root.local-selected-count + " 选中)";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: Style.link;
                }
                Rectangle { horizontal-stretch: 1; }
                Rectangle {
                    width: 12px;
                    VerticalLayout {
                        alignment: center;
                        Rectangle {
                            width: 8px;
                            height: 8px;
                            border-radius: 4px;
                            background: root.remote-connected ? Style.connected : Style.disconnected;
                        }
                    }
                }
                Text {
                    text: root.remote-connected ? "已连接" : "未连接";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: root.remote-connected ? Style.connected : Style.text-placeholder;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "远程: " + root.remote-file-count + " 项";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: Style.text-secondary;
                }
                if root.remote-selected-count > 0: Text {
                    text: "(" + root.remote-selected-count + " 选中)";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: Style.link;
                }
            }
        }
    } // VerticalBox
    } // FocusScope

    // 设置覆盖层
    settings := SettingsPage {
        visible: root.show-settings;
        z: 100;
        servers: root.servers;
        current-settings-index <=> root.current-settings-index;
        current-config <=> root.current-config;
        test-result <=> root.test-result;
        test-success <=> root.test-success;
        is-testing <=> root.is-testing;
        test-log <=> root.test-log;
        show-log <=> root.show-log;
        ssh-key-hint: root.ssh-key-hint;
        save-config(idx, cfg) => {
            root.save-config(idx, cfg);
        }
        delete-config(idx) => {
            root.delete-config(idx);
        }
        pick-key-file() => {
            root.pick-key-file();
        }
        load-config(idx) => {
            root.load-config(idx);
        }
        test-connection(cfg) => {
            root.test-connection(cfg);
        }
        close-settings() => {
            root.show-settings = false;
            root.test-result = "";
        }
    }

    // 确认对话框覆盖层
    ConfirmDialog {
        z: 150;
        title: root.confirm-title;
        message: root.confirm-message;
        show: root.show-confirm;
        confirmed() => {
            root.show-confirm = false;
            root.confirm-accepted();
        }
        cancelled() => {
            root.show-confirm = false;
        }
    }

    // 全局错误提示条
    if root.global-error != "": Rectangle {
        x: 10px;
        y: root.height - 50px;
        width: root.width - 20px;
        height: 40px;
        background: Style.bg-error;
        border-radius: 4px;
        border-width: 1px;
        border-color: Style.border-error;
        z: 200;
        HorizontalLayout {
            padding-left: 12px;
            padding-right: 8px;
            Text {
                text: root.global-error;
                color: Style.text-error;
                vertical-alignment: center;
                horizontal-stretch: 1;
                overflow: elide;
            }

            Button {
                text: "关闭";
                width: 45px;
                clicked => {
                    root.global-error = "";
                }
            }
        }
    }
}
