import {
    Button,
    VerticalBox,
    ComboBox,
    LineEdit,
    ProgressIndicator,
    HorizontalBox,
    GroupBox,
} from "std-widgets.slint";

import { SettingsPage } from "pages/settings_page.slint";
import { ServerConfigUI } from "types.slint";
import { FileEntry } from "components/file_item.slint";
import { LocalPanel } from "panels/local_panel.slint";
import { RemotePanel } from "panels/remote_panel.slint";
import { TransferEntry } from "components/transfer_item.slint";
import { TransferPanel } from "panels/transfer_panel.slint";
import { QuickUploadPanel } from "panels/quick_upload_panel.slint";
export { ServerConfigUI, FileEntry, TransferEntry }

export component AppWindow inherits Window {
    title: "Flick 文件传输";
    min-width: 700px;
    min-height: 500px;
    default-font-family: "Microsoft YaHei";
    in-out property <bool> show-settings: false;
    in-out property <int> current-settings-index: -1;
    in-out property <ServerConfigUI> current-config: {
        name: "New Server",
        host: "127.0.0.1",
        port: "22",
        user: "root",
        auth_type: "password",
        password: "",
        key_path: "",
        default_target_dir: "/tmp"
    };
    callback save-config(int, ServerConfigUI);
    callback delete-config(int);
    callback pick-key-file();
    callback load-config(int);
    callback test-connection(ServerConfigUI);
    in-out property <string> test-result: "";
    in-out property <bool> test-success: false;
    in-out property <bool> is-testing: false;
    in-out property <string> test-log: "";
    in-out property <bool> show-log: false;
    in property <string> ssh-key-hint: "留空自动探测 (Agent/Default)";
    in property <[string]> servers: ["本地测试服务器"];

    // 本地文件浏览器
    in property <string> local-path: "";
    in property <[FileEntry]> local-files: [];
    callback local-navigate(string);
    callback local-go-up();
    callback local-file-clicked(int);
    callback local-file-double-clicked(int);
    callback local-refresh();
    callback local-select-all();

    // 远程文件浏览器
    in property <string> remote-path: "/";
    in property <[FileEntry]> remote-files: [];
    in property <bool> remote-connected: false;
    in property <bool> remote-connecting: false;
    in property <string> remote-status: "";
    in-out property <int> remote-server-index: 0;
    callback remote-connect(int);
    callback remote-disconnect();
    callback remote-navigate(string);
    callback remote-go-up();
    callback remote-file-clicked(int);
    callback remote-file-double-clicked(int);
    callback remote-refresh();
    callback remote-select-all();
    callback remote-mkdir(string);
    callback remote-delete-selected();
    callback remote-rename(int, string);

    // 传输队列
    in property <[TransferEntry]> transfer-tasks: [];
    in property <bool> has-transfer-tasks: false;
    callback clear-completed-transfers();
    callback upload-selected();
    callback download-selected();

    // 快速上传模式
    in-out property <bool> quick-upload-mode: false;
    in-out property <string> file-path: "未选择文件";
    in-out property <string> target-dir: "/tmp";
    in-out property <bool> is-uploading: false;
    in-out property <float> progress: 0.0;
    in-out property <string> status-log: "";
    callback pick-file();
    callback server-selected(int);
    callback start-upload(int);

    // 全局错误提示
    in-out property <string> global-error: "";

    // 快速上传面板
    QuickUploadPanel {
        visible: root.quick-upload-mode && !root.show-settings;
        file-path: root.file-path;
        servers: root.servers;
        target-dir: root.target-dir;
        is-uploading: root.is-uploading;
        progress: root.progress;
        status-log: root.status-log;
        pick-file() => {
            root.pick-file();
        }
        server-selected(idx) => {
            root.server-selected(idx);
        }
        start-upload(idx) => {
            root.start-upload(idx);
        }
    }

    // 主界面（双面板）
    VerticalBox {
        padding: 20px;
        spacing: 15px;
        visible: !root.show-settings && !root.quick-upload-mode;
        HorizontalBox {
            alignment: space-between;
            Text {
                text: "Flick";
                font-size: 24px;
                font-weight: 700;
            }

            Button {
                text: "设置";
                width: 60px;
                clicked => {
                    root.show-settings = true;
                    root.current-settings-index = -1;
                    root.current-config = {
                        name: "New Server",
                        host: "",
                        port: "22",
                        user: "root",
                        auth_type: "password",
                        password: "",
                        key_path: "",
                        default_target_dir: "/tmp"
                    };
                }
            }
        }

        // 双面板文件浏览器
        HorizontalLayout {
            spacing: 10px;
            LocalPanel {
                width: 50%;
                current-path: root.local-path;
                files: root.local-files;
                navigate(p) => {
                    root.local-navigate(p);
                }
                go-up() => {
                    root.local-go-up();
                }
                file-clicked(i) => {
                    root.local-file-clicked(i);
                }
                file-double-clicked(i) => {
                    root.local-file-double-clicked(i);
                }
                refresh() => {
                    root.local-refresh();
                }
                select-all() => {
                    root.local-select-all();
                }
            }

            RemotePanel {
                width: 50%;
                current-path: root.remote-path;
                files: root.remote-files;
                servers: root.servers;
                connected: root.remote-connected;
                connecting: root.remote-connecting;
                status-text: root.remote-status;
                current-server-index <=> root.remote-server-index;
                connect(idx) => {
                    root.remote-connect(idx);
                }
                disconnect() => {
                    root.remote-disconnect();
                }
                navigate(p) => {
                    root.remote-navigate(p);
                }
                go-up() => {
                    root.remote-go-up();
                }
                file-clicked(i) => {
                    root.remote-file-clicked(i);
                }
                file-double-clicked(i) => {
                    root.remote-file-double-clicked(i);
                }
                refresh() => {
                    root.remote-refresh();
                }
                select-all() => {
                    root.remote-select-all();
                }
                mkdir(name) => {
                    root.remote-mkdir(name);
                }
                delete-selected() => {
                    root.remote-delete-selected();
                }
                rename-item(i, name) => {
                    root.remote-rename(i, name);
                }
            }
        }

        // 传输操作按钮
        HorizontalBox {
            alignment: center;
            spacing: 20px;
            padding-top: 10px;
            padding-bottom: 10px;
            Button {
                text: "上传选中文件";
                enabled: root.remote-connected;
                width: 150px;
                clicked => {
                    root.upload-selected();
                }
            }

            Button {
                text: "下载选中文件";
                enabled: root.remote-connected;
                width: 150px;
                clicked => {
                    root.download-selected();
                }
            }
        }

        // 传输队列面板
        TransferPanel {
            tasks: root.transfer-tasks;
            has-tasks: root.has-transfer-tasks;
            clear-completed => {
                root.clear-completed-transfers();
            }
        }
    }

    // 设置覆盖层
    settings := SettingsPage {
        visible: root.show-settings;
        z: 100;
        servers: root.servers;
        current-settings-index <=> root.current-settings-index;
        current-config <=> root.current-config;
        test-result <=> root.test-result;
        test-success <=> root.test-success;
        is-testing <=> root.is-testing;
        test-log <=> root.test-log;
        show-log <=> root.show-log;
        ssh-key-hint: root.ssh-key-hint;
        save-config(idx, cfg) => {
            root.save-config(idx, cfg);
        }
        delete-config(idx) => {
            root.delete-config(idx);
        }
        pick-key-file() => {
            root.pick-key-file();
        }
        load-config(idx) => {
            root.load-config(idx);
        }
        test-connection(cfg) => {
            root.test-connection(cfg);
        }
        close-settings() => {
            root.show-settings = false;
            root.test-result = "";
        }
    }

    // 全局错误提示条
    if root.global-error != "": Rectangle {
        x: 10px;
        y: root.height - 50px;
        width: root.width - 20px;
        height: 40px;
        background: #fee2e2;
        border-radius: 4px;
        border-width: 1px;
        border-color: #fca5a5;
        z: 200;
        HorizontalLayout {
            padding-left: 12px;
            padding-right: 8px;
            Text {
                text: root.global-error;
                color: #991b1b;
                vertical-alignment: center;
                horizontal-stretch: 1;
                overflow: elide;
            }

            Button {
                text: "关闭";
                width: 45px;
                clicked => {
                    root.global-error = "";
                }
            }
        }
    }
}
