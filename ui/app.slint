import { Button, VerticalBox, ComboBox, LineEdit, ProgressIndicator, HorizontalBox, GroupBox } from "std-widgets.slint";

import { Button, VerticalBox, ComboBox, LineEdit, ProgressIndicator, HorizontalBox, GroupBox, StandardListView, GridBox } from "std-widgets.slint";

export struct ServerConfigUI {
    name: string,
    host: string,
    port: string,
    user: string,
    auth_type: string, // "password" or "key"
    password: string,
    key_path: string,
    default_target_dir: string,
}

export component AppWindow inherits Window {
    title: "Flick æ–‡ä»¶ä¼ è¾“";
    min-width: 500px;
    min-height: 450px;
    default-font-family: "Microsoft YaHei";

    // è¾“å…¥å±æ€§
    in property <string> file-path: "æœªé€‰æ‹©æ–‡ä»¶";
    // è¿œç¨‹ç›®å½• (é»˜è®¤ä»é…ç½®åŠ è½½ï¼Œå¯ä¿®æ”¹)
    in-out property <string> target-dir: "/tmp"; 
    in property <float> progress: 0.0;
    in property <string> status-log: "ç­‰å¾…æ“ä½œ...";
    in property <[string]> servers: ["æœ¬åœ°æµ‹è¯•æœåŠ¡å™¨"];
    in property <bool> is-uploading: false;
    
    // é…ç½®ç›¸å…³ (çœç•¥...)
    in-out property <bool> show-settings: false;
    in-out property <ServerConfigUI> current-config: {
        name: "New Server",
        host: "127.0.0.1",
        port: "22",
        user: "root",
        auth_type: "password",
        password: "",
        key_path: "",
        default_target_dir: "/tmp"
    };

    // å›è°ƒå‡½æ•°
    callback start-upload(int); 
    callback cancel-upload();
    callback save-config(ServerConfigUI);
    callback delete-config(int); // é¢„ç•™
    callback pick-file(); // æµè§ˆæ–‡ä»¶
    callback server-selected(int); // æœåŠ¡å™¨åˆ‡æ¢

    GridLayout {
        // ä¸»ç•Œé¢å†…å®¹
        VerticalBox {
            padding: 20px;
            spacing: 15px;
            visible: !root.show-settings;

            HorizontalBox {
                alignment: space-between;
                Text {
                    text: "Flick âš¡";
                    font-size: 24px;
                    font-weight: 700;
                }
                Button {
                    text: "âš™ï¸ è®¾ç½®";
                    width: 80px;
                    clicked => {
                        root.show-settings = true;
                    }
                }
            }

            GroupBox {
                title: "ç›®æ ‡æ–‡ä»¶";
                HorizontalBox {
                    spacing: 5px;
                    LineEdit {
                        text: root.file-path;
                        enabled: false; // åªè¯»ï¼Œé€šè¿‡æŒ‰é’®é€‰æ‹©
                        horizontal-alignment: left;
                    }
                    Button {
                        text: "ğŸ“‚ æµè§ˆ";
                        width: 80px;
                        clicked => { root.pick-file(); }
                    }
                }
            }

            HorizontalBox {
                spacing: 10px;
                Text {
                    text: "é€‰æ‹©æœåŠ¡å™¨:";
                    vertical-alignment: center;
                    width: 80px;
                }
                server-combo := ComboBox {
                    model: root.servers;
                    current-index: 0;
                    width: 60%;
                    enabled: !root.is-uploading;
                    selected(val) => {
                        root.server-selected(self.current-index);
                    }
                }
            }

            HorizontalBox {
                spacing: 10px;
                Text {
                    text: "è¿œç¨‹ç›®å½•:";
                    vertical-alignment: center;
                    width: 80px;
                }
                LineEdit {
                    text <=> root.target-dir;
                    placeholder-text: "/tmp";
                    enabled: !root.is-uploading;
                }
            }

            VerticalBox {
                spacing: 5px;
                Text {
                    text: "ä¼ è¾“è¿›åº¦: " + Math.round(root.progress * 100) + "%";
                    font-size: 12px;
                    color: #888;
                }
                ProgressIndicator {
                    progress: root.progress;
                    height: 8px;
                }
            }

            Text {
                text: root.status-log;
                color: root.is-uploading ? #007bff : #666;
                horizontal-alignment: center;
            }

            HorizontalBox {
                alignment: center;
                Button {
                    text: root.is-uploading ? "å–æ¶ˆ" : "å¼€å§‹ä¼ è¾“"; // ç®€åŒ–æ˜¾ç¤º
                    primary: true;
                    width: 120px;
                    height: 36px;
                    enabled: !root.is-uploading; 
                    clicked => {
                        if (!root.is-uploading) {
                            root.start-upload(server-combo.current-index);
                        }
                    }
                }
            }
        }

        // è®¾ç½®è¦†ç›–å±‚
        Rectangle {
            background: #ffffff;
            visible: root.show-settings;
            z: 100; // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
            
            VerticalBox {
                padding: 20px;
                spacing: 10px;
                
                Text {
                    text: "æ·»åŠ /ç¼–è¾‘æœåŠ¡å™¨ (ç®€åŒ–ç‰ˆ: ä»…æ”¯æŒæ–°å¢)"; 
                    font-size: 18px;
                    font-weight: 700;
                }

                HorizontalBox {
                    Text { text: "åˆ«å:"; width: 80px; vertical-alignment: center; }
                    LineEdit { 
                        text <=> root.current-config.name; 
                        placeholder-text: "ä¾‹å¦‚: é˜¿é‡Œäº‘ Shanghai";
                    }
                }

                HorizontalBox {
                    Text { text: "Host:"; width: 80px; vertical-alignment: center; }
                    LineEdit { text <=> root.current-config.host; placeholder-text: "IP or Domain"; }
                    Text { text: "Port:"; width: 40px; vertical-alignment: center; }
                    LineEdit { text <=> root.current-config.port; width: 60px; }
                }

                HorizontalBox {
                    Text { text: "ç”¨æˆ·:"; width: 80px; vertical-alignment: center; }
                    LineEdit { text <=> root.current-config.user; }
                }

                HorizontalBox {
                    Text { text: "å¯†ç :"; width: 80px; vertical-alignment: center; }
                    LineEdit { 
                        text <=> root.current-config.password; 
                        input-type: password;
                        placeholder-text: "è‹¥ä½¿ç”¨ Key å¯ç•™ç©º";
                    }
                }
                 
                // ç®€åŒ–èµ·è§ï¼ŒKey Path æš‚ä¸ç›´æ¥æ”¯æŒæ–‡ä»¶é€‰æ‹©ï¼Œå…ˆç”¨æ–‡æœ¬æ¡†æˆ–è€…åªåšå¯†ç è®¤è¯
                // è‹¥è¦æ”¯æŒ Keyï¼Œéœ€è¦å¢åŠ  auth_type åˆ‡æ¢é€»è¾‘ï¼Œè¿™é‡Œä¸ºäº† MVP å…ˆæŠŠ Key Path æ”¾ç€
                HorizontalBox {
                    Text { text: "Key Path:"; width: 80px; vertical-alignment: center; }
                    LineEdit { 
                        text <=> root.current-config.key_path; 
                        placeholder-text: "ç§é’¥ç»å¯¹è·¯å¾„ (å¯é€‰)";
                    }
                }

                HorizontalBox {
                    Text { text: "ç›®æ ‡ç›®å½•:"; width: 80px; vertical-alignment: center; }
                    LineEdit { text <=> root.current-config.default_target_dir; }
                }

                HorizontalBox {
                    alignment: end;
                    spacing: 10px;
                    
                    Button {
                        text: "å–æ¶ˆ";
                        clicked => {
                            root.show-settings = false;
                        }
                    }
                    Button {
                        text: "ä¿å­˜å¹¶ä½¿ç”¨";
                        primary: true;
                        clicked => {
                            root.save-config(root.current-config);
                            root.show-settings = false;
                        }
                    }
                }
            }
        }
    }
}
