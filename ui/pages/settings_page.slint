import { Button, ComboBox, LineEdit, HorizontalBox } from "std-widgets.slint";
import { ServerConfigUI } from "../types.slint";

export component SettingsPage inherits Rectangle {
    background: #ffffff;

    in property <[string]> servers;
    in-out property <int> current-settings-index: -1;
    in-out property <ServerConfigUI> current-config: {
        name: "New Server", host: "", port: "22",
        user: "root", auth_type: "password",
        password: "", key_path: "",
        default_target_dir: "/tmp"
    };
    in-out property <string> test-result: "";
    in-out property <bool> test-success: false;
    in-out property <bool> is-testing: false;
    in-out property <string> test-log: "";
    in-out property <bool> show-log: false;
    in property <string> ssh-key-hint: "留空自动探测";

    callback save-config(int, ServerConfigUI);
    callback delete-config(int);
    callback pick-key-file();
    callback load-config(int);
    callback test-connection(ServerConfigUI);
    callback close-settings();

    HorizontalLayout {
        padding: 20px;
        spacing: 20px;

        // 左侧：服务器列表
        Rectangle {
            width: 200px;
            VerticalLayout {
                spacing: 10px;
                Text {
                    text: "服务器列表";
                    font-size: 16px;
                    font-weight: 700;
                    height: 30px;
                    vertical-alignment: center;
                }
                Rectangle {
                    background: #f5f5f5;
                    border-radius: 4px;
                    border-color: #e0e0e0;
                    border-width: 1px;
                    clip: true;
                    Flickable {
                        x: 0px; y: 0px;
                        width: 100%; height: 100%;
                        viewport-height: root.servers.length * 36px;
                        VerticalLayout {
                            alignment: start;
                            padding: 5px;
                            for server[i] in root.servers: Rectangle {
                                height: 36px;
                                border-radius: 4px;
                                background: root.current-settings-index == i ? #d0e8ff : transparent;
                                TouchArea {
                                    clicked => {
                                        root.current-settings-index = i;
                                        root.load-config(i);
                                    }
                                }
                                HorizontalBox {
                                    padding-left: 5px;
                                    Text {
                                        text: server;
                                        vertical-alignment: center;
                                        overflow: elide;
                                    }
                                }
                            }
                        }
                    }
                }
                Button {
                    text: "+ 新建服务器";
                    height: 32px;
                    clicked => {
                        root.current-settings-index = -1;
                        root.current-config = {
                            name: "New Server", host: "", port: "22",
                            user: "root", auth_type: "password",
                            password: "", key_path: "",
                            default_target_dir: "/tmp"
                        };
                    }
                }
            }
        }

        Rectangle { width: 1px; background: #ddd; }

        // 右侧：编辑表单
        Rectangle {
            VerticalLayout {
                spacing: 12px;
                alignment: start;
                Text {
                    text: root.current-settings-index == -1 ? "新建服务器" : "编辑服务器";
                    font-size: 18px;
                    font-weight: 700;
                }
                GridLayout {
                    spacing: 10px;
                    Row {
                        Text { text: "别名:"; vertical-alignment: center; }
                        LineEdit {
                            text <=> root.current-config.name;
                            placeholder-text: "例如: 阿里云 Shanghai";
                        }
                    }
                    Row {
                        Text { text: "Host:"; vertical-alignment: center; }
                        HorizontalLayout {
                            spacing: 10px;
                            LineEdit {
                                text <=> root.current-config.host;
                                placeholder-text: "IP or Domain";
                            }
                            Text { text: "Port:"; vertical-alignment: center; }
                            LineEdit { text <=> root.current-config.port; width: 60px; }
                        }
                    }
                    Row {
                        Text { text: "用户:"; vertical-alignment: center; }
                        LineEdit { text <=> root.current-config.user; }
                    }
                    Row {
                        Text { text: "认证:"; vertical-alignment: center; }
                        ComboBox {
                            model: ["Password", "Key"];
                            current-index: root.current-config.auth_type == "key" ? 1 : 0;
                            selected(val) => {
                                root.current-config.auth_type = self.current-index == 1 ? "key" : "password";
                            }
                        }
                    }
                    Row {
                        Text {
                            text: root.current-config.auth_type == "password" ? "密码:" : "Key:";
                            vertical-alignment: center;
                        }
                        Rectangle {
                            HorizontalLayout {
                                spacing: 5px;
                                if root.current-config.auth_type == "password": LineEdit {
                                    text <=> root.current-config.password;
                                    input-type: password;
                                    placeholder-text: "SSH Password";
                                    width: 100%;
                                }
                                if root.current-config.auth_type == "key": LineEdit {
                                    text <=> root.current-config.key_path;
                                    placeholder-text: root.ssh-key-hint;
                                    width: 100%;
                                }
                                if root.current-config.auth_type == "key": Button {
                                    text: "...";
                                    width: 30px;
                                    clicked => { root.pick-key-file(); }
                                }
                            }
                        }
                    }
                    Row {
                        Text { text: "目录:"; vertical-alignment: center; }
                        LineEdit { text <=> root.current-config.default_target_dir; }
                    }
                }

                // 测试结果
                VerticalLayout {
                    spacing: 5px;
                    Text {
                        text: root.test-result;
                        color: root.test-success ? #28a745 : #dc3545;
                        visible: root.test-result != "";
                        wrap: word-wrap;
                    }
                    HorizontalLayout {
                        alignment: start;
                        Button {
                            text: root.show-log ? "隐藏日志" : "查看详细日志";
                            height: 30px;
                            visible: root.test-log != "";
                            clicked => { root.show-log = !root.show-log; }
                        }
                    }
                    if root.show-log: Rectangle {
                        background: #f0f0f0;
                        border-radius: 4px;
                        height: 150px;
                        clip: true;
                        Flickable {
                            viewport-height: log-text.preferred-height;
                            log-text := Text {
                                width: parent.width;
                                text: root.test-log;
                                wrap: word-wrap;
                                font-size: 11px;
                                color: #333;
                            }
                        }
                    }
                }

                Rectangle { height: 10px; }

                HorizontalLayout {
                    alignment: end;
                    spacing: 10px;
                    Button {
                        text: "删除";
                        visible: root.current-settings-index != -1;
                        clicked => { root.delete-config(root.current-settings-index); }
                    }
                    Rectangle { width: 10px; }
                    Button {
                        text: root.is-testing ? "连接中..." : "测试连接";
                        enabled: !root.is-testing;
                        clicked => {
                            root.test-result = "正在尝试连接...";
                            root.is-testing = true;
                            root.test-connection(root.current-config);
                        }
                    }
                    Button {
                        text: "关闭";
                        clicked => { root.close-settings(); }
                    }
                    Button {
                        text: root.current-settings-index == -1 ? "保存" : "更新";
                        primary: true;
                        clicked => {
                            root.save-config(root.current-settings-index, root.current-config);
                            root.test-result = "";
                        }
                    }
                }
            }
        }
    }
}
