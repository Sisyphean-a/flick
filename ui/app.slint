import {
    Button,
    VerticalBox,
    ComboBox,
    LineEdit,
    ProgressIndicator,
    HorizontalBox,
    GroupBox,
} from "std-widgets.slint";

import {
    Button,
    VerticalBox,
    ComboBox,
    LineEdit,
    ProgressIndicator,
    HorizontalBox,
    GroupBox,
    StandardListView,
    GridBox,
} from "std-widgets.slint";

export struct ServerConfigUI {
    name: string,
    host: string,
    port: string,
    user: string,
    auth_type: string, // "password" or "key"
    password: string,
    key_path: string,
    default_target_dir: string,
}

export component AppWindow inherits Window {
    title: "Flick æ–‡ä»¶ä¼ è¾“";
    min-width: 700px;
    min-height: 500px;
    default-font-family: "Microsoft YaHei";

    // è¾“å…¥å±æ€§
    in property <string> file-path: "æœªé€‰æ‹©æ–‡ä»¶";
    // è¿œç¨‹ç›®å½• (é»˜è®¤ä»é…ç½®åŠ è½½ï¼Œå¯ä¿®æ”¹)
    in-out property <string> target-dir: "/tmp";
    in property <float> progress: 0.0;
    in property <string> status-log: "ç­‰å¾…æ“ä½œ...";
    in property <[string]> servers: ["æœ¬åœ°æµ‹è¯•æœåŠ¡å™¨"];
    in property <bool> is-uploading: false;
    
    // é…ç½®ç›¸å…³
    in-out property <bool> show-settings: false;
    in-out property <int> current-settings-index: -1; // -1 è¡¨ç¤ºæ–°å»º
    in-out property <ServerConfigUI> current-config: {
        name: "New Server",
        host: "127.0.0.1",
        port: "22",
        user: "root",
        auth_type: "password", // "password" | "key"
        password: "",
        key_path: "",
        default_target_dir: "/tmp"
    };

    // å›è°ƒå‡½æ•°
    callback start-upload(int);
    callback cancel-upload();
    callback save-config(int, ServerConfigUI); // index, config
    callback delete-config(int); // index
    callback pick-file(); // æµè§ˆä¼ è¾“æ–‡ä»¶
    callback pick-key-file(); // æµè§ˆå¯†é’¥æ–‡ä»¶
    callback load-config(int); // åŠ è½½æŒ‡å®šç´¢å¼•çš„é…ç½®åˆ°è¡¨å•
    callback server-selected(int); // ä¸»ç•Œé¢æœåŠ¡å™¨åˆ‡æ¢
    callback test-connection(ServerConfigUI); // æµ‹è¯•è¿æ¥

    // æµ‹è¯•ç»“æœåé¦ˆ
    in-out property <string> test-result: "";
    in-out property <bool> test-success: false;
    in-out property <bool> is-testing: false;
    
    // è¯¦ç»†æ—¥å¿—
    in-out property <string> test-log: "";
    in-out property <bool> show-log: false;
    
    // SSH Key æç¤ºæ–‡æ¡ˆ (åŠ¨æ€ç”Ÿæˆçš„è·¯å¾„)
    in property <string> ssh-key-hint: "ç•™ç©ºè‡ªåŠ¨æ¢æµ‹ (Agent/Default)";
    VerticalBox {
        padding: 20px;
        spacing: 15px;
        visible: !root.show-settings;
        HorizontalBox {
            alignment: space-between;
            Text {
                text: "Flick âš¡";
                font-size: 24px;
                font-weight: 700;
            }

            Button {
                text: "âš™ï¸ è®¾ç½®";
                width: 80px;
                clicked => {
                    root.show-settings = true;
                        // é»˜è®¤è¿›å…¥æ–°å»ºæ¨¡å¼æˆ–ä¿æŒä¸Šæ¬¡çŠ¶æ€? 
                        // è¿™é‡Œç®€å•å¤„ç†ï¼šæ¯æ¬¡æ‰“å¼€è®¾ç½®é‡ç½®ä¸ºæ–°å»º
                        root.current-settings-index = -1;
                    root.current-config = {
                        name: "New Server",
                        host: "",
                        port: "22",
                        user: "root",
                        auth_type: "password",
                        password: "",
                        key_path: "",
                        default_target_dir: "/tmp"
                    };
                }
            }
        }

        GroupBox {
            title: "ç›®æ ‡æ–‡ä»¶";
            HorizontalBox {
                spacing: 5px;
                LineEdit {
                    text: root.file-path;
                    enabled: false; // åªè¯»ï¼Œé€šè¿‡æŒ‰é’®é€‰æ‹©
                        horizontal-alignment: left;
                }

                Button {
                    text: "ğŸ“‚ æµè§ˆ";
                    width: 80px;
                    clicked => {
                        root.pick-file();
                    }
                }
            }
        }

        HorizontalBox {
            spacing: 10px;
            Text {
                text: "é€‰æ‹©æœåŠ¡å™¨:";
                vertical-alignment: center;
                width: 80px;
            }

            server-combo := ComboBox {
                model: root.servers;
                current-index: 0;
                width: 60%;
                enabled: !root.is-uploading;
                selected(val) => {
                    root.server-selected(self.current-index);
                }
            }
        }

        HorizontalBox {
            spacing: 10px;
            Text {
                text: "è¿œç¨‹ç›®å½•:";
                vertical-alignment: center;
                width: 80px;
            }

            LineEdit {
                text <=> root.target-dir;
                placeholder-text: "/tmp";
                enabled: !root.is-uploading;
            }
        }

        VerticalBox {
            spacing: 5px;
            Text {
                text: "ä¼ è¾“è¿›åº¦: " + Math.round(root.progress * 100) + "%";
                font-size: 12px;
                color: #888;
            }

            ProgressIndicator {
                progress: root.progress;
                height: 8px;
            }
        }

        Text {
            text: root.status-log;
            color: root.is-uploading ? #007bff : #666;
            horizontal-alignment: center;
        }

        HorizontalBox {
            alignment: center;
            Button {
                text: root.is-uploading ? "å–æ¶ˆ" : "å¼€å§‹ä¼ è¾“";
                primary: true;
                width: 120px;
                height: 36px;
                enabled: !root.is-uploading;
                clicked => {
                    if (!root.is-uploading) {
                        root.start-upload(server-combo.current-index);
                    }
                }
            }
        }
    }

        // è®¾ç½®è¦†ç›–å±‚
        Rectangle {
        background: #ffffff;
        visible: root.show-settings;
        z: 100;
        HorizontalLayout {
            padding: 20px;
            spacing: 20px;

                // å·¦ä¾§ï¼šæœåŠ¡å™¨åˆ—è¡¨
                Rectangle {
                width: 200px;
                VerticalLayout {
                    spacing: 10px;
                    Text {
                        text: "æœåŠ¡å™¨åˆ—è¡¨";
                        font-size: 16px;
                        font-weight: 700;
                        height: 30px;
                        vertical-alignment: center;
                    }
                        
                        // åˆ—è¡¨åŒºåŸŸå®¹å™¨ï¼Œé™åˆ¶é«˜åº¦
                        Rectangle {
                        background: #f5f5f5;
                        border-radius: 4px;
                        border-color: #e0e0e0;
                        border-width: 1px;
                        clip: true; // ç¡®ä¿å†…å®¹ä¸æº¢å‡º
                            
                            Flickable {
                            x: 0px;
                            y: 0px;
                            width: 100%;
                            height: 100%;
                            viewport-height: root.servers.length * 36px;
                            VerticalLayout {
                                alignment: start;
                                padding: 5px;
                                for server[i] in root.servers: Rectangle {
                                    height: 36px;
                                    border-radius: 4px;
                                    background: root.current-settings-index == i ? #d0e8ff : transparent;
                                    TouchArea {
                                        clicked => {
                                            root.current-settings-index = i;
                                            root.load-config(i);
                                        }
                                    }

                                    HorizontalBox {
                                        padding-left: 5px;
                                        Text {
                                            text: server;
                                            vertical-alignment: center;
                                            overflow: elide;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Button {
                        text: "+ æ–°å»ºæœåŠ¡å™¨";
                        height: 32px;
                        clicked => {
                            root.current-settings-index = -1;
                                // é‡ç½®è¡¨å•
                                root.current-config = {
                                name: "New Server",
                                host: "",
                                port: "22",
                                user: "root",
                                auth_type: "password",
                                password: "",
                                key_path: "",
                                default_target_dir: "/tmp"
                            };
                        }
                    }
                }
            }
                
                // å‚ç›´åˆ†å‰²çº¿
                Rectangle {
                width: 1px;
                background: #ddd;
            }

                // å³ä¾§ï¼šç¼–è¾‘è¡¨å•
                Rectangle {
                    // è‡ªåŠ¨å¡«å……å‰©ä½™å®½åº¦
                    VerticalLayout {
                    spacing: 12px;
                    alignment: start;
                    Text {
                        text: root.current-settings-index == -1 ? "æ–°å»ºæœåŠ¡å™¨" : "ç¼–è¾‘æœåŠ¡å™¨";
                        font-size: 18px;
                        font-weight: 700;
                    }

                        // è¡¨å•åŒºåŸŸ
                        GridLayout {
                        spacing: 10px;
                        Row {
                            Text {
                                text: "åˆ«å:";
                                vertical-alignment: center;
                            }

                            LineEdit {
                                text <=> root.current-config.name;
                                placeholder-text: "ä¾‹å¦‚: é˜¿é‡Œäº‘ Shanghai";
                            }
                        }

                        Row {
                            Text {
                                text: "Host:";
                                vertical-alignment: center;
                            }

                            HorizontalLayout {
                                spacing: 10px;
                                LineEdit {
                                    text <=> root.current-config.host;
                                    placeholder-text: "IP or Domain";
                                }

                                Text {
                                    text: "Port:";
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> root.current-config.port;
                                    width: 60px;
                                }
                            }
                        }

                        Row {
                            Text {
                                text: "ç”¨æˆ·:";
                                vertical-alignment: center;
                            }

                            LineEdit {
                                text <=> root.current-config.user;
                            }
                        }

                        Row {
                            Text {
                                text: "è®¤è¯:";
                                vertical-alignment: center;
                            }

                            ComboBox {
                                model: ["Password", "Key"];
                                current-index: root.current-config.auth_type == "key" ? 1 : 0;
                                selected(val) => {
                                    root.current-config.auth_type = self.current-index == 1 ? "key" : "password";
                                }
                            }
                        }
                            // åŠ¨æ€æ˜¾ç¤ºå¯†ç æˆ–Key
                            Row {
                            Text {
                                text: root.current-config.auth_type == "password" ? "å¯†ç :" : "Key:";
                                vertical-alignment: center;
                            }

                            Rectangle {
                                    // åŒ…è£…å®¹å™¨ä»¥æ”¯æŒæ¡ä»¶æ˜¾ç¤º
                                    HorizontalLayout {
                                    spacing: 5px;
                                    if (root.current-config.auth_type == "password"): LineEdit {
                                        text <=> root.current-config.password;
                                        input-type: password;
                                        placeholder-text: "SSH Password";
                                        width: 100%;
                                    }
                                    if (root.current-config.auth_type == "key"): LineEdit {
                                        text <=> root.current-config.key_path;
                                        placeholder-text: root.ssh-key-hint;
                                        width: 100%;
                                    }
                                    if (root.current-config.auth_type == "key"): Button {
                                        text: "...";
                                        width: 30px;
                                        clicked => {
                                            root.pick-key-file();
                                        }
                                    }
                                }
                            }
                        }

                        Row {
                            Text {
                                text: "ç›®å½•:";
                                vertical-alignment: center;
                            }

                            LineEdit {
                                text <=> root.current-config.default_target_dir;
                            }
                        }
                    }

                        // æµ‹è¯•ç»“æœæ˜¾ç¤º
                        VerticalLayout {
                        spacing: 5px;
                        Text {
                            text: root.test-result;
                            color: root.test-success ? #28a745 : #dc3545;
                            visible: root.test-result != "";
                            wrap: word-wrap;
                        }

                        HorizontalLayout {
                            alignment: start;
                            Button {
                                text: root.show-log ? "éšè—æ—¥å¿—" : "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—";
                                height: 30px;
                                visible: root.test-log != "";
                                clicked => {
                                    root.show-log = !root.show-log;
                                }
                            }
                        }

                        if (root.show-log): Rectangle {
                            background: #f0f0f0;
                            border-radius: 4px;
                            height: 150px;
                            clip: true;
                            Flickable {
                                viewport-height: log-text.preferred-height;
                                log-text := Text {
                                    width: parent.width;
                                    text: root.test-log;
                                    wrap: word-wrap;
                                    font-size: 11px;
                                    color: #333;
                                }
                            }
                        }
                    }

                        // åº•éƒ¨æ“ä½œæŒ‰é’® - ä½¿ç”¨ Rectangle åŒ…è£…ä»¥æ¨åˆ°åº•éƒ¨
                        Rectangle {
                        height: 10px;
                    }

                    HorizontalLayout {
                        alignment: end;
                        spacing: 10px;
                        Button {
                            text: "åˆ é™¤";
                            visible: root.current-settings-index != -1;
                            clicked => {
                                root.delete-config(root.current-settings-index);
                            }
                        }

                            // Spacer
                            Rectangle {
                            width: 10px;
                        }

                        Button {
                            text: root.is-testing ? "è¿æ¥ä¸­..." : "æµ‹è¯•è¿æ¥";
                            enabled: !root.is-testing;
                            clicked => {
                                root.test-result = "æ­£åœ¨å°è¯•è¿æ¥...";
                                root.is-testing = true;
                                root.test-connection(root.current-config);
                            }
                        }

                        Button {
                            text: "å…³é—­";
                            clicked => {
                                root.show-settings = false;
                                root.test-result = "";
                            }
                        }

                        Button {
                            text: root.current-settings-index == -1 ? "ä¿å­˜" : "æ›´æ–°";
                            primary: true;
                            clicked => {
                                root.save-config(root.current-settings-index, root.current-config);
                                root.test-result = "";
                            }
                        }
                    }
                }
            }
        }
    }
}
