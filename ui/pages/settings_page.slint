import {
    Button,
    ComboBox,
    LineEdit,
    HorizontalBox,
    CheckBox,
} from "std-widgets.slint";
import { ServerConfigUI } from "../types.slint";

export component SettingsPage inherits Rectangle {
    background: #ffffff;
    in property <[string]> servers;
    in-out property <int> current-settings-index: -1;
    in-out property <ServerConfigUI> current-config: {
        name: "New Server",
        host: "",
        port: "22",
        user: "root",
        auth_type: "password",
        password: "",
        key_path: "",
        default_target_dir: "/tmp"
    };
    in-out property <string> test-result: "";
    in-out property <bool> test-success: false;
    in-out property <bool> is-testing: false;
    in-out property <string> test-log: "";
    in-out property <bool> show-log: false;
    in property <string> ssh-key-hint: "留空自动探测";
    callback save-config(int, ServerConfigUI);
    callback delete-config(int);
    callback pick-key-file();
    callback load-config(int);
    callback test-connection(ServerConfigUI);
    callback close-settings();
    HorizontalLayout {
        padding: 20px;
        spacing: 20px;

        // 左侧：服务器列表
        Rectangle {
            width: 200px;
            VerticalLayout {
                spacing: 10px;
                Text {
                    text: "服务器列表";
                    font-size: 16px;
                    font-weight: 700;
                    height: 30px;
                    vertical-alignment: center;
                }

                Rectangle {
                    background: #f5f5f5;
                    border-radius: 4px;
                    border-color: #e0e0e0;
                    border-width: 1px;
                    clip: true;
                    Flickable {
                        x: 0px;
                        y: 0px;
                        width: 100%;
                        height: 100%;
                        viewport-height: root.servers.length * 36px;
                        VerticalLayout {
                            alignment: start;
                            padding: 5px;
                            for server[i] in root.servers: Rectangle {
                                height: 36px;
                                border-radius: 4px;
                                background: root.current-settings-index == i ? #d0e8ff : transparent;
                                TouchArea {
                                    clicked => {
                                        root.current-settings-index = i;
                                        root.load-config(i);
                                    }
                                }

                                HorizontalBox {
                                    padding-left: 5px;
                                    Text {
                                        text: server;
                                        vertical-alignment: center;
                                        overflow: elide;
                                    }
                                }
                            }
                        }
                    }
                }

                Button {
                    text: "+ 新建服务器";
                    height: 32px;
                    clicked => {
                        root.current-settings-index = -1;
                        root.current-config = {
                            name: "New Server",
                            host: "",
                            port: "22",
                            user: "root",
                            auth_type: "password",
                            password: "",
                            key_path: "",
                            default_target_dir: "/tmp"
                        };
                    }
                }
            }
        }

        Rectangle {
            width: 1px;
            background: #ddd;
        }

        // 右侧：编辑表单
        Rectangle {
            VerticalLayout {
                spacing: 12px;
                alignment: start;
                Text {
                    text: root.current-settings-index == -1 ? "新建服务器" : "编辑服务器";
                    font-size: 18px;
                    font-weight: 700;
                }

                VerticalLayout {
                    spacing: 15px;

                    // Row 1: Alias
                    HorizontalLayout {
                        Text {
                            text: "别名:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text: root.current-config.name;
                            edited(val) => { root.current-config.name = val; }
                            placeholder-text: "例如: 阿里云 Shanghai";
                            height: 30px;
                        }
                    }

                    // Row 2: Host & Port
                    HorizontalLayout {
                        Text {
                            text: "Host:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text: root.current-config.host;
                            edited(val) => { root.current-config.host = val; }
                            placeholder-text: "IP or Domain";
                            height: 30px;
                            horizontal-stretch: 1;
                        }

                        Rectangle {
                            width: 10px;
                        }

                        Text {
                            text: "Port:";
                            width: 40px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text: root.current-config.port;
                            edited(val) => { root.current-config.port = val; }
                            width: 60px;
                            height: 30px;
                        }
                    }

                    // Row 3: User
                    HorizontalLayout {
                        Text {
                            text: "用户:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text: root.current-config.user;
                            edited(val) => { root.current-config.user = val; }
                            height: 30px;
                        }
                    }

                    // Row 4: Auth Type
                    HorizontalLayout {
                        Text {
                            text: "认证:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        ComboBox {
                            model: ["Password", "Key"];
                            current-index: root.current-config.auth_type == "key" ? 1 : 0;
                            height: 30px;
                            selected(val) => {
                                root.current-config.auth_type = self.current-index == 1 ? "key" : "password";
                            }
                        }
                    }

                    // Row 5: Password / Key
                    HorizontalLayout {
                        Text {
                            text: root.current-config.auth_type == "password" ? "密码:" : "Key:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        if root.current-config.auth_type == "password": LineEdit {
                            text: root.current-config.password;
                            edited(val) => { root.current-config.password = val; }
                            input-type: password;
                            placeholder-text: "SSH Password";
                            height: 30px;
                            horizontal-stretch: 1;
                        }
                        if root.current-config.auth_type == "key": HorizontalLayout {
                            horizontal-stretch: 1;
                            spacing: 5px;
                            LineEdit {
                                text: root.current-config.key_path;
                                edited(val) => { root.current-config.key_path = val; }
                                placeholder-text: root.ssh-key-hint;
                                height: 30px;
                                horizontal-stretch: 1;
                            }

                            Button {
                                text: "...";
                                width: 40px;
                                height: 30px;
                                clicked => {
                                    root.pick-key-file();
                                }
                            }
                        }
                    }

                    // Row 6: Target Dir
                    HorizontalLayout {
                        Text {
                            text: "目录:";
                            width: 60px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text: root.current-config.default_target_dir;
                            edited(val) => { root.current-config.default_target_dir = val; }
                            height: 30px;
                        }
                    }

                    // Row 7: Default Server
                    HorizontalLayout {
                        Text {
                            width: 60px;
                        } // placeholder
                         CheckBox {
                            text: "设为默认服务器 (启动时自动选中)";
                            checked: root.current-config.is_default;
                            toggled => {
                                root.current-config.is_default = self.checked;
                            }
                        }
                    }
                }

                // 测试结果
                VerticalLayout {
                    spacing: 5px;
                    Text {
                        text: root.test-result;
                        color: root.test-success ? #28a745 : #dc3545;
                        visible: root.test-result != "";
                        wrap: word-wrap;
                    }

                    HorizontalLayout {
                        alignment: start;
                        Button {
                            text: root.show-log ? "隐藏日志" : "查看详细日志";
                            height: 30px;
                            visible: root.test-log != "";
                            clicked => {
                                root.show-log = !root.show-log;
                            }
                        }
                    }

                    if root.show-log: Rectangle {
                        background: #f0f0f0;
                        border-radius: 4px;
                        height: 150px;
                        clip: true;
                        Flickable {
                            viewport-height: log-text.preferred-height;
                            log-text := Text {
                                width: parent.width;
                                text: root.test-log;
                                wrap: word-wrap;
                                font-size: 11px;
                                color: #333;
                            }
                        }
                    }
                }

                Rectangle {
                    height: 10px;
                }

                HorizontalLayout {
                    alignment: end;
                    spacing: 10px;
                    Button {
                        text: "删除";
                        visible: root.current-settings-index != -1;
                        clicked => {
                            root.delete-config(root.current-settings-index);
                        }
                    }

                    Rectangle {
                        width: 10px;
                    }

                    Button {
                        text: root.is-testing ? "连接中..." : "测试连接";
                        enabled: !root.is-testing;
                        clicked => {
                            root.test-result = "正在尝试连接...";
                            root.is-testing = true;
                            root.test-connection(root.current-config);
                        }
                    }

                    Button {
                        text: "关闭";
                        clicked => {
                            root.close-settings();
                        }
                    }

                    Button {
                        text: root.current-settings-index == -1 ? "保存" : "更新";
                        primary: true;
                        clicked => {
                            root.save-config(root.current-settings-index, root.current-config);
                            root.test-result = "";
                        }
                    }
                }
            }
        }
    }
}
